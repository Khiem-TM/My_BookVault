server:
  port: 8888

app:
  api-prefix: /api/v1

spring:
  application:
    name: api-gateway
  data:
    redis:
      host: redis
      port: 6379
  cloud:
    gateway:
      globalcors:
        add-to-simple-url-handler-mapping: true
        corsConfigurations:
          "[/**]":
            allowedOrigins:
              - http://localhost:4173
              - http://localhost:3000
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders:
              - Authorization
              - Content-Type
              - X-Requested-With
            allowCredentials: true
            maxAge: 3600
      default-filters:
        - name: CircuitBreaker
          args:
            name: defaultCB
            fallbackUri: forward:/fallback
      routes:
        - id: identity_service
          uri: http://identity-service:8080
          predicates:
            - Path=${app.api-prefix}/identity/**
          filters:
            - StripPrefix=2
        - id: profile_service
          uri: http://profile-service:8081
          predicates:
            - Path=${app.api-prefix}/profile/users/**
          filters:
            - StripPrefix=2
        - id: notification_service
          uri: http://notification-service:8082
          predicates:
            - Path=${app.api-prefix}/notification/**
          filters:
            - StripPrefix=2
        - id: post_service
          uri: http://post-service:8083
          predicates:
            - Path=${app.api-prefix}/post/**
          filters:
            - StripPrefix=2
        - id: file_service
          uri: http://file-service:8084
          predicates:
            - Path=${app.api-prefix}/file/**
          filters:
            - StripPrefix=2
        - id: chat_service
          uri: http://chat-service:8085
          predicates:
            - Path=${app.api-prefix}/chat/**
          filters:
            - StripPrefix=2
        # Book Service Routes -> Redirected to bookx-service (ExpressJS)
        # Frontend calls /api/v1/books -> Gateway strips /api/v1 -> bookx-service:3001/api/books
        - id: book_service_query
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/books/**
            - Method=GET
          filters:
            - StripPrefix=2
            - RewritePath=/books(?<segment>.*), /api/books${segment}
            - name: RequestRateLimiter
              args:
                "[redis-rate-limiter.replenishRate]": 200
                "[redis-rate-limiter.burstCapacity]": 400
                key-resolver: "#{@ipKeyResolver}"
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, SERVICE_UNAVAILABLE, GATEWAY_TIMEOUT

        - id: book_service_management
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/books/**
            - Method=POST,PUT,DELETE
          filters:
            - StripPrefix=2
            - RewritePath=/books(?<segment>.*), /api/books${segment}
            - name: RequestRateLimiter
              args:
                "[redis-rate-limiter.replenishRate]": 50
                "[redis-rate-limiter.burstCapacity]": 100
                key-resolver: "#{@ipKeyResolver}"

        - id: book_service_reviews
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/reviews/**
          filters:
            - StripPrefix=2
            - RewritePath=/reviews/?(?<segment>.*), /api/reviews/${segment}
            - name: RequestRateLimiter
              args:
                "[redis-rate-limiter.replenishRate]": 100
                "[redis-rate-limiter.burstCapacity]": 200
                key-resolver: "#{@ipKeyResolver}"
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, SERVICE_UNAVAILABLE, GATEWAY_TIMEOUT

        - id: book_service_borrows
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/borrows/**
          filters:
            - StripPrefix=2
            - RewritePath=/borrows/?(?<segment>.*), /api/transactions/borrow
            - name: RequestRateLimiter
              args:
                "[redis-rate-limiter.replenishRate]": 100
                "[redis-rate-limiter.burstCapacity]": 200
                key-resolver: "#{@ipKeyResolver}"

        - id: book_service_rentals
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/rentals/**
          filters:
            - StripPrefix=2
            - RewritePath=/rentals/?(?<segment>.*), /api/transactions/${segment}
            - name: RequestRateLimiter
              args:
                "[redis-rate-limiter.replenishRate]": 100
                "[redis-rate-limiter.burstCapacity]": 200
                key-resolver: "#{@ipKeyResolver}"

        - id: library_service
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/library/**
          filters:
            - StripPrefix=2
            - RewritePath=/library/(?<segment>.*), /api/playlists/${segment}
            - name: RequestRateLimiter
              args:
                "[redis-rate-limiter.replenishRate]": 100
                "[redis-rate-limiter.burstCapacity]": 200
                key-resolver: "#{@ipKeyResolver}"
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, SERVICE_UNAVAILABLE, GATEWAY_TIMEOUT

        - id: transaction_service
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/transactions/**
          filters:
            - StripPrefix=2
            - RewritePath=/transactions/(?<segment>.*), /api/transactions/${segment}
            - name: RequestRateLimiter
              args:
                "[redis-rate-limiter.replenishRate]": 50
                "[redis-rate-limiter.burstCapacity]": 100
                key-resolver: "#{@ipKeyResolver}"
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, SERVICE_UNAVAILABLE, GATEWAY_TIMEOUT

        - id: order_service
          uri: http://book-service:8086
          predicates:
            - Path=${app.api-prefix}/orders/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                "[redis-rate-limiter.replenishRate]": 50
                "[redis-rate-limiter.burstCapacity]": 100
                key-resolver: "#{@ipKeyResolver}"
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, SERVICE_UNAVAILABLE, GATEWAY_TIMEOUT

        - id: payment_service
          uri: http://payment-service:8092
          predicates:
            - Path=${app.api-prefix}/payment/**
          filters:
            - StripPrefix=2
            - RewritePath=/payment/(?<segment>.*), /${segment}
            - name: RequestRateLimiter
              args:
                "[redis-rate-limiter.replenishRate]": 30
                "[redis-rate-limiter.burstCapacity]": 60
                key-resolver: "#{@ipKeyResolver}"
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, SERVICE_UNAVAILABLE, GATEWAY_TIMEOUT
