server:
  port: 8888

app:
  api-prefix: /api/v1

spring:
  application:
    name: api-gateway
  data:
    redis:
      host: ${REDIS_HOST:redis}
      port: ${REDIS_PORT:6379}
  cloud:
    gateway:
      globalcors:
        add-to-simple-url-handler-mapping: true
        corsConfigurations:
          "[/**]":
            allowedOrigins:
              - "http://localhost:4173"
              - "http://localhost:3000"
              - "http://localhost:5173"
              - "${FRONTEND_URL:http://localhost:3000}"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders:
              - Authorization
              - Content-Type
              - X-Requested-With
            allowCredentials: true
            maxAge: 3600
      default-filters:
        - name: AuthenticationFilter
        - name: CircuitBreaker
          args:
            name: defaultCB
            fallbackUri: forward:/fallback
      routes:
        - id: identity_service
          uri: http://identity-service:8080
          predicates:
            - Path=${app.api-prefix}/identity/**
          filters:
            - StripPrefix=2
        - id: profile_service
          uri: http://profile-service:8081
          predicates:
            - Path=${app.api-prefix}/profile/users/**
          filters:
            - StripPrefix=2
        - id: notification_service
          uri: http://notification-service:8082
          predicates:
            - Path=${app.api-prefix}/notification/**
          filters:
            - StripPrefix=2
        - id: post_service
          uri: http://post-service:8083
          predicates:
            - Path=${app.api-prefix}/post/**
          filters:
            - StripPrefix=2
        - id: file_service
          uri: http://file-service:8084
          predicates:
            - Path=${app.api-prefix}/file/**
          filters:
            - StripPrefix=2
        - id: chat_service
          uri: http://chat-service:8085
          predicates:
            - Path=${app.api-prefix}/chat/**
          filters:
            - StripPrefix=2
        # Book Service Routes -> Redirected to bookx-service (ExpressJS)
        # Structure: Frontend calls /api/v1/books/* -> Gateway -> bookx-service:3001/api/books/*

        # Book Management (Admin Only) - Create, Update, Delete
        # Book Management (Admin Only) - Create, Update, Delete
        - id: book_service_management
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/books
            - Method=GET,POST,PUT,DELETE
          filters:
            - RewritePath=/api/v1/(?<segment>.*), /api/${segment}
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                key-resolver: "#{@ipKeyResolver}"

        # Book Query Operations - Read, Search, Statistics
        - id: book_service_query
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/book/books/**
          filters:
            - RewritePath=/api/v1/book/(?<segment>.*), /api/${segment}
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 200
                redis-rate-limiter.burstCapacity: 400
                key-resolver: "#{@ipKeyResolver}"
        - id: book_service_borrow
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/book/borrows/**
          filters:
            - RewritePath=/api/v1/book/borrows/(?<segment>.*), /api/transactions/${segment}
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 150
                redis-rate-limiter.burstCapacity: 300
                key-resolver: "#{@ipKeyResolver}"
        - id: book_service_rental
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/book/rentals/**
          filters:
            - RewritePath=/api/v1/book/rentals/(?<segment>.*), /api/transactions/${segment}
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 150
                redis-rate-limiter.burstCapacity: 300
                key-resolver: "#{@ipKeyResolver}"
        # Legacy Book Service endpoints (split for clarity)
        - id: library_service_route
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/library/**
          filters:
            - RewritePath=/api/v1/library/(?<segment>.*), /api/playlists/${segment}
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                key-resolver: "#{@ipKeyResolver}"
        
        - id: order_service_route
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/orders/**
          filters:
            - RewritePath=/api/v1/orders/(?<segment>.*), /api/orders/${segment}
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                key-resolver: "#{@ipKeyResolver}"

        - id: review_service_route
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/review/**
          filters:
            - RewritePath=/api/v1/review/(?<segment>.*), /api/reviews/${segment}
        
        - id: transaction_service_route
          uri: http://bookx-service:3001
          predicates:
            - Path=${app.api-prefix}/transaction/**
          filters:
            - RewritePath=/api/v1/transaction(?<segment>/?.*), /api/transactions${segment}
        - id: payment_service
          uri: http://payment-service:8092
          predicates:
            - Path=${app.api-prefix}/payment/**
          filters:
            - StripPrefix=2
            - RewritePath=/payment/(?<segment>.*), /${segment}
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 30
                redis-rate-limiter.burstCapacity: 60
                key-resolver: "#{@ipKeyResolver}"
            - name: Retry
              args:
                retries: 2
                statuses: BAD_GATEWAY, SERVICE_UNAVAILABLE, GATEWAY_TIMEOUT

logging:
  level:
    root: INFO
    com.khiem: DEBUG
    org.springframework.cloud.gateway: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
