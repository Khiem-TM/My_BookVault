name: bookvault
services:
  kafka:
    image: apache/kafka:latest
    container_name: kafka
    hostname: kafka
    restart: always
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9094,CONTROLLER://0.0.0.0:9093,EXTERNAL://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9094,EXTERNAL://localhost:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3

  mongodb:
    platform: linux/arm64
    image: arm64v8/mongo:4.4
    container_name: mongodb
    hostname: mongodb
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
  mysql:
    platform: linux/amd64
    image: mysql:8.0.40-debian
    container_name: mysql
    hostname: mysql
    restart: always
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
  neo4j:
    platform: linux/amd64
    image: neo4j:5.24.2
    container_name: neo4j
    hostname: neo4j
    restart: always
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      NEO4J_AUTH: neo4j/12345678
  zipkin:
    platform: linux/amd64
    image: openzipkin/zipkin:2.24
    container_name: zipkin
    hostname: zipkin
    restart: always
    ports:
      - "9411:9411"
  redis:
    platform: linux/amd64
    image: redis:7
    container_name: redis
    hostname: redis
    restart: always
    ports:
      - "6379:6379"

  # Book Service - Clean Architecture (consolidated: orders, reviews, library, transactions)
  # book-service:
  #   build:
  #     context: ./book-service
  #   container_name: book-service
  #   restart: unless-stopped
  #   ports:
  #     - "8086:8086"
  #   environment:
  #     SPRING_DATASOURCE_URL: "jdbc:mysql://mysql:3306/bookvault?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true"
  #     SPRING_DATASOURCE_USERNAME: "root"
  #     SPRING_DATASOURCE_PASSWORD: "root"
  #     REDIS_HOST: redis
  #     MONGODB_HOST: mongodb
  #   depends_on:
  #     mysql:
  #       condition: service_started
  #   healthcheck:
  #     test:
  #       [
  #         "CMD-SHELL",
  #         "curl -sf http://localhost:8086/actuator/health >/dev/null || exit 1",
  #       ]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 10



  # Book Service (New ExpressJS/TypeScript)
  bookx-service:
    build:
        context: ./bookx-service
    container_name: bookx-service
    restart: unless-stopped
    ports:
        - "3001:3001"
    environment:
        PORT: 3001
        MYSQL_HOST: mysql
        MYSQL_PORT: 3306
        MYSQL_USER: root
        MYSQL_PASSWORD: root
        MYSQL_DATABASE: bookx_db
        MONGO_URI: mongodb://mongodb:27017/bookx_db
        REDIS_URL: redis://redis:6379
        JWT_SECRET: "1TjXchw5FloESb63Kc+DFhTARvpWL4jUGCwfGWxuG5SIf/1y/LgJxHnMqaF6A/ij"
        IDENTITY_SERVICE_URL: "http://identity-service:8080/identity"
    depends_on:
        mysql:
            condition: service_started
        mongodb:
            condition: service_started
    healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
        interval: 10s
        timeout: 5s
        retries: 5

  # File Service
  file-service:
    build:
      context: ./file-service
    container_name: file-service
    restart: unless-stopped
    ports:
      - "8084:8084"
    environment:
      SPRING_DATA_MONGODB_URI: "mongodb://root:root@mongodb:27017/file-service?authSource=admin"
      APP_FILE_STORAGE_DIR: "/uploads"
      APP_FILE_DOWNLOAD_PREFIX: "http://localhost:8888/api/v1/file/media/download/"
    volumes:
      - ./uploads:/uploads
    depends_on:
      mongodb:
        condition: service_started
    healthcheck:
      test:
        ["CMD-SHELL", "curl -s http://localhost:8084/file >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Profile Service
  profile-service:
    build:
      context: ./profile-service
    container_name: profile-service
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      SPRING_NEO4J_URI: "bolt://neo4j:7687"
      SPRING_NEO4J_AUTHENTICATION_USERNAME: "neo4j"
      SPRING_NEO4J_AUTHENTICATION_PASSWORD: "12345678"
      APP_SERVICES_FILE: "http://file-service:8084"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka:9094"
    depends_on:
      neo4j:
        condition: service_started
      file-service:
        condition: service_started
      kafka:
        condition: service_started
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s http://localhost:8081/profile >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  # Identity Service
  identity-service:
    build:
      context: ./identity-service
    container_name: identity-service
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: "jdbc:mysql://mysql:3306/bookvault_identity?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true"
      SPRING_DATASOURCE_USERNAME: "root"
      SPRING_DATASOURCE_PASSWORD: "root"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka:9094"
      APP_SERVICES_PROFILE: "http://profile-service:8081/profile"
    depends_on:
      mysql:
        condition: service_started
      kafka:
        condition: service_started
      profile-service:
        condition: service_started
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s http://localhost:8080/identity >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  # Post Service
  post-service:
    build:
      context: ./post-service
    container_name: post-service
    restart: unless-stopped
    ports:
      - "8083:8083"
    environment:
      SPRING_DATA_MONGODB_URI: "mongodb://root:root@mongodb:27017/post-service?authSource=admin"
      APP_SERVICES_PROFILE_URL: "http://profile-service:8081/profile"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka:9094"
    depends_on:
      mongodb:
        condition: service_started
      profile-service:
        condition: service_started
    healthcheck:
      test:
        ["CMD-SHELL", "curl -s http://localhost:8083/post >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Chat Service
  chat-service:
    build:
      context: ./chat-service
    container_name: chat-service
    restart: unless-stopped
    ports:
      - "8085:8085"
    environment:
      SPRING_DATA_MONGODB_URI: "mongodb://root:root@mongodb:27017/chat-service?authSource=admin"
      APP_SERVICES_PROFILE_URL: "http://profile-service:8081/profile"
    depends_on:
      mongodb:
        condition: service_started
      profile-service:
        condition: service_started
    healthcheck:
      test:
        ["CMD-SHELL", "curl -s http://localhost:8085/chat >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Notification Service
  notification-service:
    build:
      context: ./notification-service
    container_name: notification-service
    restart: unless-stopped
    ports:
      - "8082:8082"
    environment:
      SPRING_DATA_MONGODB_URI: "mongodb://root:root@mongodb:27017/notification-service?authSource=admin"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka:9094"
      BREVO_API_KEY: ${BREVO_API_KEY}
    depends_on:
      mongodb:
        condition: service_started
      kafka:
        condition: service_started
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -s http://localhost:8082/notification >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  # Payment Service
  payment-service:
    build:
      context: ./payment-service
    container_name: payment-service
    restart: unless-stopped
    ports:
      - "8092:8092"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sf http://localhost:8092/actuator/health >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - "8888:8888"
    environment:
      SPRING_DATA_REDIS_HOST: "redis"
      SPRING_PROFILES_ACTIVE: "docker"
    depends_on:
      identity-service:
        condition: service_started
      bookx-service:
        condition: service_started
      payment-service:
        condition: service_started
      file-service:
        condition: service_started
      chat-service:
        condition: service_started
      post-service:
        condition: service_started
      profile-service:
        condition: service_started
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sf http://localhost:8888/actuator/health >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
